# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the master branch
  push:
    branches: [ master ]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # Label of the container job
  container-job:
    # Containers must run in Linux based operating systems
    runs-on: ubuntu-latest
    # Docker Hub image that `container-job` executes in
    container: node:10.18-jessie
    services:
      mymssqlserver:
        image: docker.io/crzysan/mssqldocker:latest
        ports:
        - 1443:1433/tcp
        env:
          ACCEPT_EULA: Y
          SA_PASSWORD: Passw0rd
          MSSQL_DB: mydb
          MSSQL_USER: myuser
          MSSQL_PASSWORD: Mypass1
    steps:
    - uses: actions/checkout@v2
    - name: Install dependencies
      run: |
        cat /etc/lsb-release
        apt update -y
        apt install software-properties-common -y
        yes | add-apt-repository ppa:deadsnakes/ppa
        apt install -y python3 apt-transport-https
        ls -latr /usr/bin/python*
        rm -rf /usr/bin/python
        ln -s /usr/bin/python3.4 /usr/bin/python
        apt-get install -y gnupg
        apt-get install curl -y
        curl https://packages.microsoft.com/keys/microsoft.asc | apt-key add -
        curl https://packages.microsoft.com/config/debian/10/prod.list > /etc/apt/sources.list.d/mssql-release.list
        apt-get update -y
        ACCEPT_EULA=Y apt-get install -y msodbcsql17
        apt-get -y install python3.7-dev gcc g++ unixodbc-dev
        python -m virtualenv antenv
        source antenv/bin/activate
        pip install --upgrade pip
        pip install -r requirements.txt
    - name: Run Tests
      run: |
        python manage.py makemigrations
        python manage.py makemigrations feedapp
        python manage.py migrate
        python manage.py test feedapp/


